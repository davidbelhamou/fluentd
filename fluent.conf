# Global settings for verbose logging
<system>
  log_level debug
  suppress_repeated_stacktrace false
  emit_error_log_interval 1
  suppress_config_dump false
</system>

# Prometheus Monitoring Sources
<source>
  @type prometheus
  @id in_prometheus_monitor
  bind 0.0.0.0
  port 24231
  metrics_path /metrics
</source>

<source>
  @type prometheus_monitor
  @id in_prometheus_monitor_agent
  interval 30
</source>

<source>
  @type prometheus_output_monitor
  @id in_prometheus_output_monitor_agent
  interval 30
</source>

# Tail source for application logs
<source>
  @type tail
  @id in_tail_python_logs
  path /var/log/app/my-logs-*.log
  pos_file /var/log/fluentd/pos/python-logs.pos
  tag python-logs
  read_from_head true
  <parse>
    @type json
  </parse>
</source>

# Elasticsearch output to data stream
<match python-logs>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  index_name python-logs
  data_stream true
  log_es_400_reason true
  bulk_message_request_threshold 100
  <buffer>
    @type file
    path /var/log/fluentd/buffer/python-logs.buffer
    flush_mode interval
    flush_interval 1s
    retry_forever true
    chunk_limit_size 2M
    queue_limit_length 32
    overflow_action block
  </buffer>
</match>
